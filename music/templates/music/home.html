{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MusicaPalBody ‚Äì Spotify Player</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

    body {
      color:#fff;
      background:url("{% static 'bg-image/R1.jpg' %}") center/cover fixed;
      overflow-x:hidden !important;
    }

    /* ==== SIDEBAR ==== */
    .sidebar {
        width: 250px;
        flex-shrink:0;
        height: 100vh;
        padding: 25px 20px;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(15px);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        position: fixed;
        left: 0;
        top: 0;
        z-index: 20;
    }
    .logo { font-size:26px; font-weight:bold; margin-bottom:25px; color:#fff; }
    .nav-item {
      display:flex; align-items:center; color:rgba(255,255,255,0.8);
      padding:10px 15px; margin-bottom:8px; border-radius:6px;
      transition:0.3s; cursor:pointer; text-decoration:none;
    }
    .nav-item i { margin-right:10px; }
    .nav-item:hover, .nav-item.active { background:rgba(255,255,255,0.25); color:#fff; }

    /* ==== MAIN CONTENT ==== */
    .main-content {
        margin-left: 250px;
        padding: 30px;
        min-height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        position: relative;
        z-index: 10;
        overflow-x: hidden;
        flex:1;
        padding:30px;
        min-height:100vh;
    }

    .search-header {
      display:flex; justify-content:center; gap:10px; margin-bottom:25px;
    }
    .search-header input {
      width:60%; padding:12px; border-radius:8px; border:none;
      background:rgba(255,255,255,0.1); color:#fff; outline:none;
    }
    .search-header button {
      padding:12px 18px; border:none; border-radius:8px;
      background:#1db954; color:#fff; font-weight:bold; cursor:pointer;
      transition:0.3s;
    }
    .search-header button:hover { background:#1ed760; }

    /* ==== SONGS ==== */
    .song-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:25px; }
    .song-card {
      background:rgba(255,255,255,0.1); border-radius:10px; padding:15px; text-align:center;
      transition:0.3s; cursor:pointer;
    }
    .song-card:hover { transform:translateY(-5px); background:rgba(255,255,255,0.2); }
    .song-card img { width:100%; height:180px; border-radius:8px; object-fit:cover; margin-bottom:10px; }
    .song-card h4 { font-size:15px; color:#fff; margin-bottom:4px; }
    .song-card p { font-size:13px; color:rgba(255,255,255,0.7); }

    .no-results { text-align:center; margin-top:40px; color:rgba(255,255,255,0.6); }

    /* ==== PLAYER BAR ==== */
    .now-playing {
      position:fixed; bottom:0; left:250px; right:0;
      background:rgba(0,0,0,0.85); backdrop-filter:blur(20px);
      display:flex; align-items:center; justify-content:space-between;
      padding:15px 30px; border-top:1px solid rgba(255,255,255,0.2);
    }
    .now-playing-info { display:flex; align-items:center; flex:1; }
    .now-playing-cover { width:55px; height:55px; border-radius:8px; margin-right:15px; }
    .now-playing-text h4 { font-size:16px; margin:0; }
    .player-controls i { margin:0 10px; font-size:20px; cursor:pointer; color:#fff; transition:0.3s; }
    .player-controls i:hover { transform:scale(1.2); color:#1ed760; }

    /* ==== DRAWER ==== */
    .drawer {
      position:fixed; bottom:-100%; left:0; right:0; height:90%;
      background:linear-gradient(180deg,#121212,#000);
      color:#fff; display:flex; flex-direction:column; align-items:center;
      border-radius:20px 20px 0 0; transition:bottom 0.5s ease,opacity 0.3s ease;
      opacity:0; z-index:200; backdrop-filter:blur(20px);
    }
    .drawer.open { bottom:0; opacity:1; }
    .drawer-cover { width:240px; height:240px; border-radius:15px; margin-top:20px; }
    .drawer-actions { display:flex; gap:20px; margin-top:15px; }
    .drawer-actions button {
      background:none; border:none; color:rgba(255,255,255,0.8);
      font-size:22px; cursor:pointer; transition:0.2s;
    }
    .drawer-actions button:hover { color:#1db954; transform:scale(1.2); }

    /* ==== MODAL ==== */
    .modal-overlay {
      position:fixed; inset:0; display:none; justify-content:center; align-items:center;
      background:rgba(0,0,0,0.7); backdrop-filter:blur(10px); z-index:300;
    }
    .modal-box {
      background:rgba(30,30,30,0.95); padding:25px; border-radius:15px;
      width:360px; color:#fff; text-align:center;
    }
    .modal-actions { margin-top:20px; display:flex; justify-content:space-around; }
    .modal-actions button {
      padding:10px 20px; border:none; border-radius:8px; font-weight:600; cursor:pointer;
      background:#1db954; color:#fff;
    }
    #modal-cancel { background:rgba(255,255,255,0.2); }

    /* ==== CAROUSELS ==== */
    .carousel-container { margin-bottom:50px; position:relative; padding-left: 10px; }
    .carousel-title { font-size:20px; font-weight:bold; margin-bottom:10px; }
    .carousel { display:flex; gap:20px; overflow-x:auto; scroll-behavior:smooth; }
    .carousel::-webkit-scrollbar { display:none; }
    .carousel .song-card { flex:0 0 180px; }
    .carousel-btn {
      position:absolute; top:50%; transform:translateY(-50%);
      background:rgba(0,0,0,0.6); color:#fff; border:none; width:38px; height:38px;
      border-radius:50%; cursor:pointer; opacity:0; transition:0.3s;
    }
    .carousel-container:hover .carousel-btn { opacity:1; }
    .carousel-btn.left { left:5px; } .carousel-btn.right { right:5px; }
  </style>
</head>

<body>
  <div class="layout">

    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="logo">MusicaPalBody</div>

      <a href="{% url 'home' %}" class="nav-item"><i class="fas fa-home"></i> Home</a>
      <a href="{% url 'favorites' %}" class="nav-item"><i class="fas fa-heart"></i> Favoritos</a>
      <a href="{% url 'playlists' %}" class="nav-item"><i class="fas fa-list"></i> Playlists</a>
      <a href="{% url 'profile' %}" class="nav-item"><i class="fas fa-user"></i> Perfil</a>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      <div class="search-header">
        <input id="searchInput" placeholder="Buscar canci√≥n o artista...">
        <button id="searchBtn"><i class="fas fa-search"></i> Buscar</button>
      </div>

      <div id="results" class="song-grid"></div>
      <div id="noResults" class="no-results" style="display:none;">No se encontraron canciones.</div>

      <!-- CARRUSELES -->
      <div id="carousels">
          <div class="carousel-container">
              <h2 class="carousel-title">üé∏ Rock Essentials</h2>
              <button class="carousel-btn left" data-target="rock-carousel"><i class="fas fa-chevron-left"></i></button>
              <div class="carousel" id="rock-carousel"></div>
              <button class="carousel-btn right" data-target="rock-carousel"><i class="fas fa-chevron-right"></i></button>
          </div>

          <div class="carousel-container">
              <h2 class="carousel-title">üé∂ Pop Latino</hh2>
              <button class="carousel-btn left" data-target="pop-carousel"><i class="fas fa-chevron-left"></i></button>
              <div class="carousel" id="pop-carousel"></div>
              <button class="carousel-btn right" data-target="pop-carousel"><i class="fas fa-chevron-right"></i></button>
          </div>

          <div class="carousel-container">
              <h2 class="carousel-title">üéß Electronic Beats</h2>
              <button class="carousel-btn left" data-target="electronic-carousel"><i class="fas fa-chevron-left"></i></button>
              <div class="carousel" id="electronic-carousel"></div>
              <button class="carousel-btn right" data-target="electronic-carousel"><i class="fas fa-chevron-right"></i></button>
          </div>

          <div class="carousel-container">
              <h2 class="carousel-title">‚ù§Ô∏è Baladas Rom√°nticas</h2>
              <button class="carousel-btn left" data-target="romantic-carousel"><i class="fas fa-chevron-left"></i></button>
              <div class="carousel" id="romantic-carousel"></div>
              <button class="carousel-btn right" data-target="romantic-carousel"><i class="fas fa-chevron-right"></i></button>
          </div>
      </div>
    </div>

    <!-- PLAYER BAR -->
    <div class="now-playing">
      <div class="now-playing-info">
        <img id="player-cover" class="now-playing-cover" src="{% static 'bg-image/R1.jpg' %}" alt="cover">
        <div class="now-playing-text">
          <h4 id="player-title">Selecciona una canci√≥n</h4>
          <p id="player-artist"></p>
        </div>
      </div>
      <div class="player-controls">
        <i class="fas fa-step-backward" id="prev-btn"></i>
        <i class="fas fa-play-circle" id="play-btn"></i>
        <i class="fas fa-step-forward" id="next-btn"></i>
      </div>
      <audio id="audio-player"></audio>
    </div>

    <!-- MODAL -->
    <div id="modal-overlay" class="modal-overlay">
      <div class="modal-box">
        <h3 id="modal-title"></h3>
        <div id="modal-content"></div>
        <div class="modal-actions">
          <button id="modal-cancel">Cancelar</button>
          <button id="modal-confirm">Aceptar</button>
        </div>
      </div>
    </div>

    <script>
      /* ==== UTILIDADES ==== */
      const $ = sel => document.querySelector(sel);
      const audio = $('#audio-player');

      let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      let playlists = JSON.parse(localStorage.getItem('playlists') || '[]');
      const save = () => {
        localStorage.setItem('favorites', JSON.stringify(favorites));
        localStorage.setItem('playlists', JSON.stringify(playlists));
      };

      let currentSong = null;

      /* ==== DRAWER ==== */
      const drawer = document.createElement('div');
      drawer.className = 'drawer';
      drawer.innerHTML = `
        <div class="drawer-header"><i class="fas fa-chevron-down" id="close-drawer"></i></div>
        <img id="drawer-cover" class="drawer-cover">
        <h2 id="drawer-title"></h2>
        <p id="drawer-artist"></p>
        <div class="drawer-actions">
          <button id="fav-btn"><i class="fas fa-heart"></i></button>
          <button id="new-playlist-btn"><i class="fas fa-plus"></i></button>
          <button id="add-to-playlist-btn"><i class="fas fa-folder-plus"></i></button>
        </div>
        <div id="drawer-player"></div>`;
      document.body.appendChild(drawer);

      const openDrawer = song => {
        currentSong = song;

        $('#drawer-cover').src = song.cover;
        $('#drawer-title').textContent = song.title;
        $('#drawer-artist').textContent = song.artist;

        const p = $('#drawer-player');
        p.innerHTML = song.preview_url
          ? `<audio controls autoplay src="${song.preview_url}"></audio>`
          : `<div class='no-preview'><p>üéµ No hay preview disponible</p></div>`;

        drawer.classList.add('open');
      };

      document.body.addEventListener('click', e => {
        if (e.target.id === 'close-drawer') drawer.classList.remove('open');
      });

      /* ==== MODAL ==== */
      const modal = $('#modal-overlay'),
            modalTitle = $('#modal-title'),
            modalContent = $('#modal-content');
      let modalCallback = null;

      const openModal = (title, html, callback = null) => {
        modalTitle.textContent = title;
        modalContent.innerHTML = html;
        modal.style.display = 'flex';
        modalCallback = callback;
      };
      $('#modal-cancel').onclick = () => modal.style.display = 'none';
      $('#modal-confirm').onclick = () => {
        if (modalCallback) modalCallback();
        modal.style.display = 'none';
      };

      /* ==== FAVORITOS & PLAYLISTS ==== */
      document.addEventListener('click', e => {

        // FAVORITOS
        if (e.target.closest('#fav-btn')) {
          if (!currentSong) return;

          if (!favorites.find(f => f.title === currentSong.title && f.artist === currentSong.artist)) {
            favorites.push(currentSong);
            save();
            openModal('Favoritos', `<p>üéµ ${currentSong.title} agregado a favoritos.</p>`);
          } else {
            openModal('Favoritos', `<p>‚ö†Ô∏è Ya est√° en favoritos.</p>`);
          }
        }

        // NUEVA PLAYLIST
        if (e.target.closest('#new-playlist-btn')) {
          openModal('Nueva Playlist', `
            <input id="playlist-name" placeholder="Nombre de la playlist"
            style="width:80%;padding:8px;border-radius:5px;">`, () => {
            const name = $('#playlist-name').value.trim();
            if (name && !playlists.find(p => p.name === name)) {
              playlists.push({ name, songs: [] });
              save();
              openModal('‚úÖ Playlist creada', `<p>"${name}" fue creada exitosamente.</p>`);
            } else {
              openModal('‚ö†Ô∏è Error', `<p>Nombre inv√°lido o repetido.</p>`);
            }
          });
        }

        // AGREGAR A PLAYLIST
        if (e.target.closest('#add-to-playlist-btn')) {
          if (!currentSong) return;
          if (!playlists.length) {
            return openModal('Sin playlists', '<p>No tienes playlists creadas.</p>');
          }

          openModal('Agregar a Playlist',
            playlists.map((p, i) =>
              `<div class='playlist-option' data-i='${i}'
              style='padding:8px;margin:5px;background:rgba(255,255,255,0.1);
              border-radius:8px;cursor:pointer;'>${p.name}</div>`
            ).join('')
          );

          modalContent.querySelectorAll('.playlist-option').forEach(opt => {
            opt.onclick = () => {
              const i = opt.dataset.i;
              playlists[i].songs.push(currentSong);
              save();
              modal.style.display = 'none';
              openModal('‚úÖ Agregado', `<p>${currentSong.title} agregado a "${playlists[i].name}".</p>`);
            };
          });
        }
      });

      /* ==== BUSCAR ==== */
      async function searchSongs() {
        const q = $('#searchInput').value.trim();
        if (!q) return;
        $('#results').innerHTML = '<p class="no-results">Buscando...</p>';
        $('#noResults').style.display = 'none';

        try {
          const res = await fetch(`/api/deezer/?q=${encodeURIComponent(q)}`);
          const data = await res.json();
          renderSongs(data.songs || []);
        } catch (err) {
          $('#results').innerHTML = '';
          $('#noResults').style.display = 'block';
        }
      }
      $('#searchBtn').onclick = searchSongs;
      $('#searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') searchSongs(); });

      function renderSongs(songs) {
        const r = $('#results');
        r.innerHTML = '';
        if (!songs.length) {
          $('#noResults').style.display = 'block';
          return;
        }
        $('#noResults').style.display = 'none';

        songs.forEach(song => {
          const card = document.createElement('div');
          card.className = 'song-card';
          card.innerHTML = `<img src="${song.cover}"><h4>${song.title}</h4><p>${song.artist}</p>`;
          card.onclick = () => openDrawer(song);
          r.appendChild(card);
        });
      }

      /* ==== CARRUSELES ==== */
      const genres = [
        { id: 'rock-carousel', query: 'Queen' },
        { id: 'pop-carousel', query: 'Dua Lipa' },
        { id: 'electronic-carousel', query: 'Daft Punk' },
        { id: 'romantic-carousel', query: 'Luis Miguel' }
      ];

      genres.forEach(async g => {
        const c = document.getElementById(g.id);
        if (!c) return;
        try {
          const res = await fetch(`/api/deezer/?q=${encodeURIComponent(g.query)}`);
          const data = await res.json();
          (data.songs || []).slice(0, 10).forEach(song => {
            const card = document.createElement('div');
            card.className = 'song-card';
            card.innerHTML = `<img src="${song.cover}"><h4>${song.title}</h4><p>${song.artist}</p>`;
            card.onclick = () => openDrawer(song);
            c.appendChild(card);
          });
        } catch (err) {}
      });

      document.querySelectorAll('.carousel-btn').forEach(b => {
        b.onclick = () => {
          const c = document.getElementById(b.dataset.target);
          c.scrollBy({ left: b.classList.contains('left') ? -400 : 400, behavior: 'smooth' });
        };
      });

    </script>

  </div>
</body>
</html>
